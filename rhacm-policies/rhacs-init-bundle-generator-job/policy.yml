apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: rhacs-init-bundle-generator-job
  namespace: rhacm-policies
  annotations:
    policy.open-cluster-management.io/categories: CA Security Assessment and Authorization
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/controls: CA-2 Security Assessments, CA-7 Continuous Monitoring
spec:
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: rhacs-clusterinit-job-ns
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Namespace
                metadata:
                  name: '{{ ( index ( lookup "config.openshift.io/v1"  "Infrastructure" "" "cluster").status.infrastructureName ) }}'
          pruneObjectBehavior: DeleteIfCreated
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: rhacs-clusterinit-job
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: batch/v1
                kind: Job
                metadata:
                  name: rhacs-init-bundle-generator-job
                  namespace: '{{ ( index ( lookup "config.openshift.io/v1"  "Infrastructure" "" "cluster").status.infrastructureName ) }}'
                spec:
                  selector: {}
                  template:
                    metadata:
                      name: roxctl
                    spec:
                      containers:
                        - name: roxctl
                          image: registry.redhat.io/advanced-cluster-security/rhacs-roxctl-rhel8:3.73.1
                          command:
                            - -e "$ROX_CENTRAL_ADDRESS" --insecure-skip-tls-verify -p "$(cat /var/run/secrets/central-pw)" central whoami
                          env:
                            ROX_CENTRAL_ADDRESS: 'central-stackrox.{{hub ( index ( lookup "config.openshift.io/v1"  "Ingress" "" "cluster").spec.domain ) hub}}:443'
                            #ROX_CENTRAL_ADMIN_PW: '{{hub fromSecret "stackrox" "central-htpasswd" "password" hub}}'
                          volumeMounts:
                          - name: central-pw
                            mountPath: "/var/run/secrets/central-pw"
                            readOnly: true
                      restartPolicy: Never
                      volumes:
                      - name: central-pw
                        secret:
                          secretName: central-htpasswd
                          optional: false

